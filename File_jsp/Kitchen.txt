<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.List" %>
<%@ page import="java.util.ArrayList" %>
<%
    // --- 1. KIỂM TRA SESSION (BẢO MẬT) ---
    Object userRole = session.getAttribute("USER_ROLE");
    Object userName = session.getAttribute("USER_NAME");

    if (userName == null) {
        // Chưa đăng nhập -> Đá về trang Login
        response.sendRedirect("Login.html");
        return;
    }
    
    // --- 2. LẤY DỮ LIỆU TỪ SERVLET ---
    // KitchenServlet sẽ query DB lấy toàn bộ đơn hàng và gửi sang đây
    List<?> orderList = (List<?>) request.getAttribute("ORDER_LIST");
    
    // Xử lý null (tránh lỗi khi chưa có backend)
    if (orderList == null) orderList = new ArrayList<>();
%>

<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FPT Food - Bếp</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* --- CSS --- */
      :root { --primary: #ff6600; --bg-page: #f5f7fa; --text-dark: #333; --text-gray: #777; --border-radius: 8px; --shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
      * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
      body { background-color: var(--bg-page); color: var(--text-dark); }
      .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
      header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 30px; box-shadow: var(--shadow); margin-bottom: 30px; }
      .brand h1 { color: var(--primary); font-size: 22px; font-weight: 700; } .brand p { font-size: 13px; color: var(--text-gray); }
      .btn-logout { padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; text-decoration: none; color: inherit; }
      .page-title { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; } .title-icon { font-size: 28px; color: var(--primary); } .title-text h2 { font-size: 20px; } .title-text p { font-size: 13px; color: var(--text-gray); }
      .tabs-container { background: #e9ecef; border-radius: 30px; padding: 5px; display: flex; margin-bottom: 30px; }
      .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 25px; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; }
      .tab-btn.active { background: white; color: var(--text-dark); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
      .content-area { background: white; border-radius: var(--border-radius); min-height: 400px; padding: 20px; box-shadow: var(--shadow); position: relative; }
      .empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; }
      .empty-icon { font-size: 60px; margin-bottom: 15px; color: #ddd; } .empty-text { font-size: 16px; margin-bottom: 5px; color: #777; } .empty-sub { font-size: 13px; }
      .order-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
      .order-card { border: 1px solid #eee; border-radius: var(--border-radius); padding: 20px; background: #fff; border-left: 5px solid var(--primary); animation: slideIn 0.3s ease; }
      @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .order-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; }
      .table-name { font-weight: bold; font-size: 16px; } .time { font-size: 12px; color: #888; display: flex; align-items: center; gap: 5px; }
      .order-items { margin-bottom: 15px; } .item-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; } .item-qty { font-weight: bold; color: var(--primary); margin-right: 10px; }
      .btn-action { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; background: #28a745; }
      .btn-action:hover { background: #218838; }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <h1>FPT Food - Bếp</h1>
        <p>Xin chào, <b><%= userName.toString() %></b></p>
      </div>
      <a href="LogoutServlet" class="btn-logout">
        <i class="fas fa-sign-out-alt"></i> Đăng xuất
      </a>
    </header>

    <div class="container">
      <div class="page-title">
        <i class="fas fa-bell title-icon"></i>
        <div class="title-text">
          <h2>Nhận đơn hàng</h2>
          <p>Quản lý và xử lý đơn hàng từ khách</p>
        </div>
      </div>

      <div class="tabs-container">
        <button class="tab-btn active" onclick="filterOrders('pending', this)">
          Chờ xử lý (<span id="count-pending">0</span>)
        </button>
        <button class="tab-btn" onclick="filterOrders('cooking', this)">
          Đang chuẩn bị (<span id="count-cooking">0</span>)
        </button>
        <button class="tab-btn" onclick="filterOrders('all', this)">
          Tất cả (<span id="count-all">0</span>)
        </button>
      </div>

      <div class="content-area">
        <div id="orderGrid" class="order-grid"></div>

        <div id="emptyState" class="empty-state">
          <i class="fas fa-utensils empty-icon"></i>
          <div class="empty-text">Không có đơn hàng nào</div>
          <div class="empty-sub" id="emptySubText">Không có đơn hàng mới</div>
        </div>
      </div>
    </div>

    <script>
      // 1. DỮ LIỆU TỪ SERVER (Java render ra Javascript Array)
      const orders = [
      <% 
        if(orderList != null && !orderList.isEmpty()) {
            /* // BẠN SẼ MỞ COMMENT NÀY KHI CÓ CLASS ORDER CỦA BẠN
               for(Order o : orderList) {
            */
      %>
            /*
            {
                id: <%= 1 %>, // o.getId()
                tableName: "<%= "Bàn 1" %>", // o.getTableName()
                time: "<%= "10:30" %>", // o.getTime()
                status: "<%= "pending" %>", // o.getStatus(): "pending", "cooking", "done"
                items: [
                    // Loop items
                    { name: "Phở Bò", qty: 2 }, 
                    { name: "Trà Đá", qty: 1 }
                ]
            },
            */
      <% 
            /* } */
        } else {
            // --- DỮ LIỆU MOCK ĐỂ TEST GIAO DIỆN (Khi chưa có DB) ---
      %>
            {
                id: 101,
                tableName: "Bàn 5",
                time: "12:30",
                status: "pending",
                items: [
                    { name: "Pizza Hải Sản", qty: 1 },
                    { name: "Pepsi", qty: 2 }
                ]
            },
            {
                id: 102,
                tableName: "Bàn 2",
                time: "12:35",
                status: "cooking",
                items: [
                    { name: "Mì Ý Bò", qty: 1 }
                ]
            },
      <% } %>
      ];

      // Biến lưu tab hiện tại
      var currentTab = "pending";

      // 2. Hàm Render
      function renderOrders() {
        var grid = document.getElementById("orderGrid");
        var emptyState = document.getElementById("emptyState");

        // Lọc đơn hàng theo Tab
        var filteredOrders = orders;
        if (currentTab === "pending") {
          filteredOrders = orders.filter(function(o) { return o.status === "pending"; });
          document.getElementById("emptySubText").innerText = "Không có đơn hàng mới";
        } else if (currentTab === "cooking") {
          filteredOrders = orders.filter(function(o) { return o.status === "cooking"; });
          document.getElementById("emptySubText").innerText = "Không có đơn đang chuẩn bị";
        } else {
             document.getElementById("emptySubText").innerText = "Danh sách trống";
        }

        updateCounts();

        if (filteredOrders.length === 0) {
          grid.innerHTML = "";
          emptyState.style.display = "block";
        } else {
          emptyState.style.display = "none";
          // Render HTML
          var html = "";
          filteredOrders.forEach(function(order) {
              var itemsHtml = "";
              order.items.forEach(function(item) {
                  itemsHtml += '<div class="item-row"><span><span class="item-qty">x' + item.qty + '</span> ' + item.name + '</span></div>';
              });

              html += '<div class="order-card">' +
                        '<div class="order-header">' +
                            '<div class="table-name">' + order.tableName + '</div>' +
                            '<div class="time"><i class="far fa-clock"></i> ' + order.time + '</div>' +
                        '</div>' +
                        '<div class="order-items">' + itemsHtml + '</div>' +
                        renderActionForm(order) +
                    '</div>';
          });
          grid.innerHTML = html;
        }
      }

      // 3. HÀM SINH FORM (Đã sửa lỗi let -> var)
      function renderActionForm(order) {
        var actionUrl = "UpdateOrderServlet"; 
        var btnText = "";
        var nextStatus = "";
        var btnColor = "";

        if (order.status === "pending") {
            btnText = "Nhận đơn & Nấu";
            nextStatus = "cooking";
            btnColor = "#ff6600";
        } else if (order.status === "cooking") {
            btnText = "Hoàn thành";
            nextStatus = "done";
            btnColor = "#28a745";
        } else {
            return '<div style="text-align:center; color:green; font-weight:bold;"><i class="fas fa-check"></i> Đã xong</div>';
        }

        // Trả về HTML Form
        return '<form action="' + actionUrl + '" method="GET">' +
                '<input type="hidden" name="orderId" value="' + order.id + '">' +
                '<input type="hidden" name="status" value="' + nextStatus + '">' +
                '<button type="submit" class="btn-action" style="background:' + btnColor + '">' +
                    btnText +
                '</button>' +
            '</form>';
      }

      function filterOrders(status, btnElement) {
        currentTab = status;
        var btns = document.querySelectorAll(".tab-btn");
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove("active");
        }
        btnElement.classList.add("active");
        renderOrders();
      }

      function updateCounts() {
        var pending = 0;
        var cooking = 0;
        
        for(var i=0; i<orders.length; i++) {
            if(orders[i].status === 'pending') pending++;
            if(orders[i].status === 'cooking') cooking++;
        }
        
        var all = orders.length;

        document.getElementById("count-pending").innerText = pending;
        document.getElementById("count-cooking").innerText = cooking;
        document.getElementById("count-all").innerText = all;
      }

      // Khởi chạy
      renderOrders();
    </script>
  </body>
</html>